<div class="tpl-show">
  <header class="tpl-head">
    <div class="tpl-title">
      <h1><%= @latex_template.title %></h1>
      <div class="tpl-meta">
        <span class="chip owner">
          Eigentümer: <%= @latex_template.user&.email || @latex_template.user_id %>
        </span>
        <span class="chip vis <%= @latex_template.visibility %>">
          <%= @latex_template.visibility %>
        </span>
        <span class="chip uses">
          Benutzt: <%= @latex_template.try(:usage_count) || "0x" %>
        </span>
      </div>
    </div>

    <div class="tpl-actions">
      <%= link_to "Zur Galerie", latex_templates_path, class: "btn ghost" %>
    </div>
  </header>

  <% if @latex_template.description.present? %>
    <section class="tpl-desc">
      <p><%= @latex_template.description %></p>
    </section>
  <% end %>

  <section class="tpl-preview">
    <h2>Vorschau (Auszug)</h2>
    <pre class="preview-block"><%= truncate(@latex_template.body.to_s, length: 300) %></pre>

    <details class="code-details">
      <summary>Kompletten LaTeX-Code anzeigen</summary>
      <div class="code-toolbar">
        <button type="button" class="btn ghost" data-copy="#tpl-code">
          In Zwischenablage kopieren
        </button>
      </div>
      <pre id="tpl-code" class="code-block"><%= @latex_template.body %></pre>
    </details>
  </section>

  <section class="tpl-generate">
    <h2>Dokument aus Template erzeugen</h2>
    <%= form_with url: documents_path,
                  scope: :document,
                  method: :post,
                  html: { class: "doc-gen-form", multipart: true } do |f| %>
      <%= hidden_field_tag "document[template_id]", @latex_template.id %>
      <div class="form-grid">
        <div class="form-group">
          <label for="doc_title">Titel</label>
          <%= f.text_field :title, id: "doc_title", class: "input" %>
        </div>
        <div class="form-group">
          <label for="doc_date">Datum</label>
          <%= text_field_tag "document[params][date]", nil, id: "doc_date", class: "input" %>
        </div>
        <div class="form-group">
          <label for="doc_first">Vorname</label>
          <%= text_field_tag "document[params][first_name]", nil, id: "doc_first", class: "input" %>
        </div>
        <div class="form-group">
          <label for="doc_last">Nachname</label>
          <%= text_field_tag "document[params][last_name]", nil, id: "doc_last", class: "input" %>
        </div>
        <div class="form-group" style="grid-column:1/-1">
          <%= f.label :image, "Optionales Bild" %>
          <%= f.file_field :image,
                accept: "image/*",
                id: "doc_image",
                class: "input" %>
          <small class="help">Wird automatisch mit \includegraphics eingebettet.</small>
          <img id="doc_image_preview" style="display:none;max-width:240px;margin-top:.5rem" />
        </div>
      </div>
      <div class="form-actions" style="display:flex;justify-content:flex-end;margin-top:.8rem">
        <%= f.submit "Dokument erzeugen", class: "btn" %>
      </div>
    <% end %>

    <script>
    document.addEventListener("change", function (e) {
      if (e.target && e.target.id === "doc_image" && e.target.files && e.target.files[0]) {
        const f = e.target.files[0];
        if (!/^image\//.test(f.type)) {
          alert("Bitte wähle eine Bilddatei (PNG/JPG/WebP/GIF).");
          e.target.value = "";
          document.getElementById("doc_image_preview").style.display = "none";
          return;
        }
        const img = document.getElementById("doc_image_preview");
        img.src = URL.createObjectURL(f);
        img.style.display = "block";
      }
    }, { passive: true });
    </script>
  </section>
</div>
