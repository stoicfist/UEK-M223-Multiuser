<% content_for :title, "Aus Template erzeugen: #{@latex_template.title}" %>

<div class="doc-form-shell">
  <section class="doc-form-card">
    <header class="doc-form-head">
      <div>
        <h2 class="doc-form-title"><%= @latex_template.title %></h2>
        <div class="doc-meta">
          <span class="badge <%= @latex_template.visibility %>"><%= @latex_template.visibility %></span>
          <% if @latex_template.description.present? %>
            <span class="doc-desc"><%= @latex_template.description %></span>
          <% end %>
        </div>
      </div>
      <%= link_to "ZurÃ¼ck", latex_template_path(@latex_template), class: "btn-secondary" %>
    </header>

    <%= form_with model: Document.new,
                  url: documents_path,
                  scope: :document,
                  local: true,
                  data: { turbo: false },
                  html: { enctype: "multipart/form-data", class: "doc-gen-form" } do |f| %>

      <%= f.hidden_field :template_id, value: @latex_template.id %>

      <div class="form-grid">
        <div class="form-group">
          <label for="doc_title">Titel</label>
          <%= f.text_field :title, id: "doc_title", class: "input" %>
        </div>

        <div class="form-group">
          <label for="doc_date">Datum</label>
          <%= text_field_tag "document[params][date]", nil, id: "doc_date", class: "input" %>
        </div>

        <div class="form-group">
          <label for="doc_first">Vorname</label>
          <%= text_field_tag "document[params][first_name]", nil, id: "doc_first", class: "input" %>
        </div>

        <div class="form-group">
          <label for="doc_last">Nachname</label>
          <%= text_field_tag "document[params][last_name]", nil, id: "doc_last", class: "input" %>
        </div>

        <div class="form-group" style="grid-column:1/-1">
          <label for="doc_image">Optionales Bild</label>
          <%= f.file_field :image, id: "doc_image", class: "input", accept: "image/*", direct_upload: true %>
          <img id="img_preview" alt="" style="display:none;max-width:220px;border-radius:8px;margin-top:.5rem;">
          <small class="help">Wird automatisch mit \includegraphics eingebettet.</small>
        </div>
      </div>

      <div class="form-actions" style="display:flex;justify-content:flex-end;margin-top:.8rem">
        <%= f.submit "Dokument erzeugen", class: "btn" %>
      </div>
    <% end %>
  </section>
</div>

<script>
document.addEventListener("turbo:load", () => {
  const input = document.getElementById("doc_image");
  const out   = document.getElementById("img_preview");
  if (!input || !out) return;

  input.addEventListener("change", () => {
    const file = input.files?.[0];
    if (file && file.type.startsWith("image/")) {
      out.src = URL.createObjectURL(file);
      out.style.display = "block";
    } else {
      out.removeAttribute("src");
      out.style.display = "none";
    }
  });
});
</script>

